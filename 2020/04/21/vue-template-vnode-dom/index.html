<!DOCTYPE html><html lang="zh-Hans" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Vue从template到DOM | Hexo</title><meta name="description" content="直接开干 Compile12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989"><meta name="author" content="Xi Yu"><meta name="copyright" content="Xi Yu"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Vue从template到DOM"><meta name="twitter:description" content="直接开干 Compile12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989"><meta name="twitter:image" content="https://xiyu.github.io/img/post.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Vue从template到DOM"><meta property="og:url" content="https://xiyu.github.io/2020/04/21/vue-template-vnode-dom/"><meta property="og:site_name" content="Hexo"><meta property="og:description" content="直接开干 Compile12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697989"><meta property="og:image" content="https://xiyu.github.io/img/post.jpg"><meta property="article:published_time" content="2020-04-21T02:15:50.223Z"><meta property="article:modified_time" content="2020-04-22T04:35:02.100Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://xiyu.github.io/2020/04/21/vue-template-vnode-dom/"><link rel="prev" title="音频截取拼接合成一个新的mp3音频文件播放，下载。" href="https://xiyu.github.io/2020/06/22/webAudio/"><link rel="next" title="Balls" href="https://xiyu.github.io/2020/04/17/balls/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">4</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Compile"><span class="toc-number">1.</span> <span class="toc-text">Compile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VNode"><span class="toc-number">2.</span> <span class="toc-text">VNode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Patch-与-Diff"><span class="toc-number">3.</span> <span class="toc-text">Patch 与 Diff</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Vue3-0-diff优化"><span class="toc-number">4.</span> <span class="toc-text">Vue3.0 diff优化</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Hexo</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Vue从template到DOM</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="Created 2020-04-21 10:15:50"><i class="fa fa-calendar" aria-hidden="true"></i> Created 2020-04-21</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="Updated 2020-04-22 12:35:02"><i class="fa fa-history" aria-hidden="true"></i> Updated 2020-04-22</span></time></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>Post View:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><p>直接开干</p>
<h3 id="Compile"><a href="#Compile" class="headerlink" title="Compile"></a>Compile</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">首先我们要知道解析之后得到了什么，我们先把 vue-template-compiler 这个方法抽离出来 </span><br><span class="line">const compiler  &#x3D; require(&quot;vue-template-compiler&quot;);</span><br><span class="line"></span><br><span class="line">举个例子解析一段 </span><br><span class="line">&lt;div&gt;&lt;div v-show&#x3D;&quot;true&quot;&gt;&#123;&#123;v.a&#125;&#125;&lt;&#x2F;div&gt;&lt;&#x2F;div&gt;</span><br><span class="line">那么我们通过如下代码测试</span><br><span class="line"></span><br><span class="line">const html &#x3D; &#39;&lt;div id&#x3D;&quot;template&quot;&gt;&lt;div v-show&#x3D;&quot;true&quot;&gt;&#123;&#123;v.a&#125;&#125;&lt;&#x2F;div&gt;&lt;&#x2F;div&gt;&#39;;</span><br><span class="line">const compHtml &#x3D; compiler.compile(html);</span><br><span class="line">console.log(compHtml);</span><br><span class="line"></span><br><span class="line">最后得到的是</span><br><span class="line">    $ node testcomplie.js</span><br><span class="line">    &#123;</span><br><span class="line">        ast: &#123;</span><br><span class="line">            type: 1,</span><br><span class="line">            tag: &#39;div&#39;,</span><br><span class="line">            attrsList: [],</span><br><span class="line">            attrsMap: &#123;&#125;,</span><br><span class="line">            rawAttrsMap: &#123;&#125;,</span><br><span class="line">            parent: undefined,</span><br><span class="line">            children: [ [Object] ],</span><br><span class="line">            plain: true,</span><br><span class="line">            static: false,</span><br><span class="line">            staticRoot: false</span><br><span class="line">        &#125;,</span><br><span class="line">        render: &#96;with(this)&#123;return _c(&#39;div&#39;,&#123;attrs:&#123;&quot;id&quot;:&quot;template&quot;&#125;&#125;,[_c(&#39;div&#39;,&#123;directives:[&#123;name:&quot;show&quot;,rawName:&quot;v-show&quot;,value:(true),expression:&quot;true&quot;&#125;]&#125;,[_v(_s(v.a))])])&#125;&#96;,</span><br><span class="line">        staticRenderFns: [],</span><br><span class="line">        errors: [],</span><br><span class="line">        tips: []</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">第一个 属性 “ast”很好解释，它就是这个html的抽象语法树，里面包含的是这个html的基本属性，</span><br><span class="line">第二个 属性 “render”  它就是后面的用来生成Vnode的render函数的原型，this 代码的就是 VUE这个实例子，里面的_c 就是一个内置的方法的对应，以下就是VUE 源码里定义的方法原型</span><br><span class="line"> &#x2F;*  *&#x2F;</span><br><span class="line"></span><br><span class="line">function installRenderHelpers (target) &#123;</span><br><span class="line">    target._o &#x3D; markOnce;</span><br><span class="line">    target._n &#x3D; toNumber;</span><br><span class="line">    target._s &#x3D; toString;</span><br><span class="line">    target._l &#x3D; renderList;</span><br><span class="line">    target._t &#x3D; renderSlot;</span><br><span class="line">    target._q &#x3D; looseEqual;</span><br><span class="line">    target._i &#x3D; looseIndexOf;</span><br><span class="line">    target._m &#x3D; renderStatic;</span><br><span class="line">    target._f &#x3D; resolveFilter;</span><br><span class="line">    target._k &#x3D; checkKeyCodes;</span><br><span class="line">    target._b &#x3D; bindObjectProps;</span><br><span class="line">    target._v &#x3D; createTextVNode;</span><br><span class="line">    target._e &#x3D; createEmptyVNode;</span><br><span class="line">    target._u &#x3D; resolveScopedSlots;</span><br><span class="line">    target._g &#x3D; bindObjectListeners;</span><br><span class="line">    target._d &#x3D; bindDynamicKeys;</span><br><span class="line">    target._p &#x3D; prependModifier;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_c 并没有愉快的跟它们在一起玩耍，而是把它定义在了 FunctionalRenderContext 里面然后通过原型的方式的传递给了 installRenderHelpers(FunctionalRenderContext.prototype)。</span><br><span class="line"></span><br><span class="line">元素属性，节点，特殊节点判断所需的内容都已在内部做了定义</span><br><span class="line">var isAttr &#x3D; makeMap(</span><br><span class="line">&#39;accept,accept-charset,accesskey,action,align,alt,async,autocomplete,&#39; +</span><br><span class="line">&#39;autofocus,autoplay,autosave,bgcolor,border,buffered,challenge,charset,&#39; +</span><br><span class="line">&#39;checked,cite,class,code,codebase,color,cols,colspan,content,http-equiv,&#39; +</span><br><span class="line">&#39;name,contenteditable,contextmenu,controls,coords,data,datetime,default,&#39; +</span><br><span class="line">&#39;defer,dir,dirname,disabled,download,draggable,dropzone,enctype,method,for,&#39; +</span><br><span class="line">&#39;form,formaction,headers,height,hidden,high,href,hreflang,http-equiv,&#39; +</span><br><span class="line">&#39;icon,id,ismap,itemprop,keytype,kind,label,lang,language,list,loop,low,&#39; +</span><br><span class="line">&#39;manifest,max,maxlength,media,method,GET,POST,min,multiple,email,file,&#39; +</span><br><span class="line">&#39;muted,name,novalidate,open,optimum,pattern,ping,placeholder,poster,&#39; +</span><br><span class="line">&#39;preload,radiogroup,readonly,rel,required,reversed,rows,rowspan,sandbox,&#39; +</span><br><span class="line">&#39;scope,scoped,seamless,selected,shape,size,type,text,password,sizes,span,&#39; +</span><br><span class="line">&#39;spellcheck,src,srcdoc,srclang,srcset,start,step,style,summary,tabindex,&#39; +</span><br><span class="line">&#39;target,title,type,usemap,value,width,wrap&#39;</span><br><span class="line">);</span><br><span class="line">var isBooleanAttr &#x3D; makeMap(</span><br><span class="line">&#39;allowfullscreen,async,autofocus,autoplay,checked,compact,controls,declare,&#39; +</span><br><span class="line">&#39;default,defaultchecked,defaultmuted,defaultselected,defer,disabled,&#39; +</span><br><span class="line">&#39;enabled,formnovalidate,hidden,indeterminate,inert,ismap,itemscope,loop,multiple,&#39; +</span><br><span class="line">&#39;muted,nohref,noresize,noshade,novalidate,nowrap,open,pauseonexit,readonly,&#39; +</span><br><span class="line">&#39;required,reversed,scoped,seamless,selected,sortable,translate,&#39; +</span><br><span class="line">&#39;truespeed,typemustmatch,visible&#39;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">&#x2F;*  *&#x2F;</span><br><span class="line"></span><br><span class="line">&#x2F;*  *&#x2F;</span><br><span class="line"></span><br><span class="line">var isHTMLTag &#x3D; makeMap(</span><br><span class="line">&#39;html,body,base,head,link,meta,style,title,&#39; +</span><br><span class="line">&#39;address,article,aside,footer,header,h1,h2,h3,h4,h5,h6,hgroup,nav,section,&#39; +</span><br><span class="line">&#39;div,dd,dl,dt,figcaption,figure,picture,hr,img,li,main,ol,p,pre,ul,&#39; +</span><br><span class="line">&#39;a,b,abbr,bdi,bdo,br,cite,code,data,dfn,em,i,kbd,mark,q,rp,rt,rtc,ruby,&#39; +</span><br><span class="line">&#39;s,samp,small,span,strong,sub,sup,time,u,var,wbr,area,audio,map,track,video,&#39; +</span><br><span class="line">&#39;embed,object,param,source,canvas,script,noscript,del,ins,&#39; +</span><br><span class="line">&#39;caption,col,colgroup,table,thead,tbody,td,th,tr,&#39; +</span><br><span class="line">&#39;button,datalist,fieldset,form,input,label,legend,meter,optgroup,option,&#39; +</span><br><span class="line">&#39;output,progress,select,textarea,&#39; +</span><br><span class="line">&#39;details,dialog,menu,menuitem,summary,&#39; +</span><br><span class="line">&#39;content,element,shadow,template,blockquote,iframe,tfoot&#39;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; this map is intentionally selective, only covering SVG elements that may</span><br><span class="line">&#x2F;&#x2F; contain child elements.</span><br><span class="line">var isSVG &#x3D; makeMap(</span><br><span class="line">&#39;svg,animate,circle,clippath,cursor,defs,desc,ellipse,filter,font-face,&#39; +</span><br><span class="line">&#39;foreignObject,g,glyph,image,line,marker,mask,missing-glyph,path,pattern,&#39; +</span><br><span class="line">&#39;polygon,polyline,rect,switch,symbol,text,textpath,tspan,use,view&#39;,</span><br><span class="line">true</span><br><span class="line">);</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">第三个 属性 “staticRenderFns” 它主要是用来存放静态元素的，在数据更新驱动的时候会跳过这些静态元素不去做处理，这里对它的概念还是有点模糊，那来点直观点的实力还是上面的例子</span><br><span class="line">我们把html改一下 </span><br><span class="line">const html &#x3D; &#39;&lt;div id&#x3D;&quot;template&quot;&gt;&lt;div&gt;&lt;span&gt;静态语法树&lt;&#x2F;span&gt;&lt;&#x2F;div&gt;&lt;div v-show&#x3D;&quot;true&quot;&gt;&#123;&#123;v.a&#125;&#125;&lt;&#x2F;div&gt;&lt;&#x2F;div&gt;&#39;;</span><br><span class="line">增加了一个没有带属性的静态的文本元素</span><br><span class="line">我们在执行一下</span><br><span class="line">$ node testcomplie.js</span><br><span class="line"> ...</span><br><span class="line">     render: &#96;with(this)&#123;return _c(&#39;div&#39;,&#123;attrs:&#123;&quot;id&quot;:&quot;template&quot;&#125;&#125;,[_m(0),_c(&#39;div&#39;,&#123;directives:[&#123;name:&quot;show&quot;,rawName:&quot;v-show&quot;,value:(true),expression:&quot;true&quot;&#125;]&#125;,[_v(_s(v.a))])])&#125;&#96;,</span><br><span class="line">     staticRenderFns: [ &#96;with(this)&#123;return _c(&#39;div&#39;,[_c(&#39;span&#39;,[_v(&quot;静态语法树&quot;)])])&#125;&#96; ],</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">可以看到静态的部分就会被另外存放到staticRenderFns这个数组里。</span><br><span class="line"></span><br><span class="line">后面两个属性跳过，暂时没有任何图用。</span><br><span class="line"></span><br><span class="line">最后通过 compileToFunctions方法转换为render 可执行方法。</span><br><span class="line">可以理解为，当然具体代码不会只有这么一点，一大堆的逻辑判断少不了 </span><br><span class="line">new Function(&#96;with(this)&#123;return [_c(&#39;div&#39;,[_c(&#39;div&#39;,&#123;directives:[&#123;name:&quot;show&quot;,rawName:&quot;v-show&quot;,value:(true),expression:&quot;true&quot;&#125;]&#125;)])]&#125;&#96;)；</span><br></pre></td></tr></table></figure>

<h3 id="VNode"><a href="#VNode" class="headerlink" title="VNode"></a>VNode</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">虚拟dom其实就是用js对象来描述或者表达一个真实的DOM，它的优点就是可以减少对DOM的操作优化性能，方便数据驱动视图更新，上面的Render是怎么变成DOM的呢？</span><br><span class="line">还得从里面的那些_c或者_v方法等等说起。</span><br><span class="line">创建成VNode 的主要是</span><br><span class="line">    target._v &#x3D; createTextVNode;</span><br><span class="line">    target._e &#x3D; createEmptyVNode;</span><br><span class="line">    target._c....</span><br><span class="line">    其它的是用于处理其它问题</span><br><span class="line">举源码例子:</span><br><span class="line">    target._v &#x3D; createTextVNode;</span><br><span class="line">这个 createTextVNode 就是vue.js源码里定义的</span><br><span class="line">    function createTextVNode (val) &#123;</span><br><span class="line">        return new VNode(undefined, undefined, undefined, String(val))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">它里面的new VNode 是生成VNode的核心</span><br><span class="line">    var VNode &#x3D; function VNode (</span><br><span class="line">    tag,</span><br><span class="line">    data,</span><br><span class="line">    children,</span><br><span class="line">    text,</span><br><span class="line">    elm,</span><br><span class="line">    context,</span><br><span class="line">    componentOptions,</span><br><span class="line">    asyncFactory</span><br><span class="line">  ) &#123;</span><br><span class="line">    this.tag &#x3D; tag;</span><br><span class="line">    this.data &#x3D; data;</span><br><span class="line">    this.children &#x3D; children;</span><br><span class="line">    .....</span><br><span class="line">其它 &#39;_字母&#39; 方法里用的都是这个套路，经过上面这些 &#39;_字母&#39; 方法处理过后得到的最终VNode是这样的，</span><br><span class="line">    &#123;    </span><br><span class="line">        asyncFactory: undefined</span><br><span class="line">        asyncMeta: undefined</span><br><span class="line">        children: (1) [VNode]   &#x2F;&#x2F;子节点数组</span><br><span class="line">        componentInstance: undefined    &#x2F;&#x2F;组件实例</span><br><span class="line">        componentOptions: undefined     &#x2F;&#x2F;组件选项</span><br><span class="line">        context: Vue &#123;_uid: 0, _isVue: true, $options: &#123;…&#125;, _renderProxy: Proxy, _self: Vue, …&#125; &#x2F;&#x2F;Vue组件实例</span><br><span class="line">        data: &#123;                &#x2F;&#x2F;节点属性</span><br><span class="line">            attrs: &#123;</span><br><span class="line">                id: &quot;template&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        elm: div#template      &#x2F;&#x2F;对应的dom节点</span><br><span class="line">        fnContext: undefined</span><br><span class="line">        fnOptions: undefined</span><br><span class="line">        fnScopeId: undefined</span><br><span class="line">        isAsyncPlaceholder: false</span><br><span class="line">        isCloned: false</span><br><span class="line">        isComment: false        &#x2F;&#x2F;是否为组件</span><br><span class="line">        isOnce: false</span><br><span class="line">        isRootInsert: true      &#x2F;&#x2F;是否为根节点</span><br><span class="line">        isStatic: false         &#x2F;&#x2F;是否为静态元素</span><br><span class="line">        key: undefined          &#x2F;&#x2F;key属性</span><br><span class="line">        ns: undefined</span><br><span class="line">        parent: undefined</span><br><span class="line">        raw: false</span><br><span class="line">        tag: &quot;div&quot;              &#x2F;&#x2F;节点名称</span><br><span class="line">        text: undefined         &#x2F;&#x2F;文本内容</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Patch-与-Diff"><a href="#Patch-与-Diff" class="headerlink" title="Patch 与 Diff"></a>Patch 与 Diff</h3><figure class="highlight patch"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">最后通过得到VNode 与 oldVNode，把它们俩交给</span><br><span class="line">    function patchVnode (</span><br><span class="line">      oldVnode,</span><br><span class="line">      vnode,</span><br><span class="line">      insertedVnodeQueue,</span><br><span class="line">      ownerArray,</span><br><span class="line">      index,</span><br><span class="line">      removeOnly</span><br><span class="line">    ) &#123;</span><br><span class="line">      if (oldVnode <span class="comment">=== vnode) &#123;</span></span><br><span class="line">        return</span><br><span class="line">      &#125;</span><br><span class="line">做对比，</span><br><span class="line">    对比方案大致分为5种：</span><br><span class="line">    1，如果VNode 与 oldVNode相等就直接跳过；</span><br><span class="line">    2，如果VNode 与 oldVNode是文本元素就直接做文本替换；</span><br><span class="line">    3，如果VNode里有子元素而old里没有就创建一个新的往old里插入；</span><br><span class="line">    4，如果VNode里没有子元素而old里有就直接删除old里的子元素；</span><br><span class="line">    5，如果VNode和old里都有子元素就去对双方子元素做对比，具体触发 updateChildren()这个方法；</span><br><span class="line"></span><br><span class="line">    以下为updateChildren() 对比判断方法</span><br><span class="line">    ![Image text](https://xiyu-526.github.io/img/20200421/1.png)</span><br><span class="line"></span><br><span class="line">    源码里需要用到 updateChildren 的条件只有下面这一个，其它的都是暴利对比,比如只要一遇到不同的直接删除，</span><br><span class="line">    if (isUndef(vnode.text)) &#123;                      //如果有存在文本</span><br><span class="line">        if (isDef(oldCh) &amp;&amp; isDef(ch)) &#123;            //并且都有 子元素</span><br><span class="line">          if (oldCh !== ch) &#123;                       //并且子元素不相等</span><br><span class="line">              updateChildren(elm, oldCh, ch, insertedVnodeQueue, removeOnly); </span><br><span class="line">          &#125; </span><br><span class="line">    </span><br><span class="line">    眼见为实,测试代码：</span><br><span class="line">    &lt;div id="template"&gt;</span><br><span class="line">      &lt;div class="msg"&gt;</span><br><span class="line">        &#123;&#123;message&#125;&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;button @click="mp3Close()"&gt;改变&lt;/button&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">    &lt;script src="node_modules/vue/dist/vue.js"&gt;&lt;/script&gt;</span><br><span class="line">    &lt;script&gt;</span><br><span class="line">      </span><br><span class="line">         var vm = new Vue(&#123;</span><br><span class="line">             el:"#template",</span><br><span class="line">             data: &#123; </span><br><span class="line">                 message: "hello Vue",</span><br><span class="line">                 key: "wodow",</span><br><span class="line">                 test: 1,</span><br><span class="line">                </span><br><span class="line">                 list: &#123;</span><br><span class="line">                     b:1</span><br><span class="line">                 &#125;,</span><br><span class="line">                 aa:&#123;</span><br><span class="line">                     b: [1,2,3]</span><br><span class="line">                 &#125;</span><br><span class="line">             &#125;,</span><br><span class="line">             methods:&#123;</span><br><span class="line">                mp3Close()&#123;</span><br><span class="line">                   if(this.message<span class="comment">==="hello Vue")</span></span><br><span class="line">                   this.message = "明天high起来"</span><br><span class="line">                   else</span><br><span class="line">                   this.message = "hello Vue"</span><br><span class="line">                &#125;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;)</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">    打印结果：</span><br><span class="line">    ![Image text](https://xiyu-526.github.io/img/20200421/1.png)</span><br><span class="line">    从图可看出，当遇到都有子元素且不相同而且都有文本的情况才会触发updateChildren，其它情况该新建的新建，该销毁的销毁，该替换的替换;</span><br><span class="line">    updateChildren是diff算法的核心，VUE2.0+的算法是照搬的snabbdom 有兴趣可以关注下https://github.com/snabbdom/snabbdom/tree/master/src，</span><br><span class="line">    对比策略大致就是 循环递归去对VNode 与 oldVNode 首尾双端节点去做对比，</span><br><span class="line"></span><br><span class="line">    之前的diff算法时间复杂度是 O(n^3)，什么为时间复杂度O(n^3)？</span><br><span class="line">    比方有如下两颗树：</span><br><span class="line">    1,2,3,4,5</span><br><span class="line">    2,3,6,7,8</span><br><span class="line"></span><br><span class="line">    两两对比会是如下情况：</span><br><span class="line">    1-2</span><br><span class="line">    1-3</span><br><span class="line">    1-6</span><br><span class="line">    1-7</span><br><span class="line">    1-8</span><br><span class="line"></span><br><span class="line">    2-2</span><br><span class="line">    2-3</span><br><span class="line">    ...</span><br><span class="line">    以此类推 这里就形成了 n^2次方，</span><br><span class="line">    再进行树的编辑(插入、替换、删除)需要再遍历一次，因此时间复杂度会再多一次方最终就是O(n^3)，也就是说如果双方存在1000个节点，那么最终要计算的次数就是1000*1000*1000 这在Web中是无法忍受的，因此React的开发人员对它做了优化：</span><br><span class="line">    1，只做同层对比，</span><br><span class="line">    2，遇到不同的直接删除，</span><br><span class="line">    3，遇到相同的直接跳过。</span><br><span class="line">    把 O(n^3) 缩减到了 O(n)，</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    React对比的原则是第一个元素不动 然后对其它后面的进行逐一对比，没有的直接做DOM删除,</span><br><span class="line">    React 对比方法举例</span><br><span class="line">    old 1,2,3,4,5,6</span><br><span class="line">    new 3,1,2,5,4</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    缺点就是如果遇到 </span><br><span class="line">    old 1,2,3,4</span><br><span class="line">    new 4,1,2,3</span><br><span class="line"></span><br><span class="line">    那么它的匹配次数</span><br><span class="line">    2,3,4,1</span><br><span class="line">    3,4,1,2</span><br><span class="line">    4,1,2,3</span><br><span class="line">    三次</span><br><span class="line"></span><br><span class="line">    而如果是VUE的话,根据上面源码的逻辑判断，Old的结束节点和New的开始节点相同的时候就会直接把Old的结束节点移动到New的开始节点位置</span><br><span class="line">    4,1,2,3</span><br><span class="line">    一次</span><br></pre></td></tr></table></figure>
<h3 id="Vue3-0-diff优化"><a href="#Vue3-0-diff优化" class="headerlink" title="Vue3.0 diff优化"></a>Vue3.0 diff优化</h3><p>``` 优化方案<br>做了序列预处理机制，先从左往右对比遇到不同停止继续，然后再从右往左对比遇到不同停止继续，这样就得到了一个对比的区间，以后的patch diff 就在这个区间中进行，<br>采用了跟跟inferno一样的方案，通过最长递增子序列的方法去做对比，</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Xi Yu</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://xiyu.github.io/2020/04/21/vue-template-vnode-dom/">https://xiyu.github.io/2020/04/21/vue-template-vnode-dom/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/img/post.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2020/06/22/webAudio/"><img class="prev_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">音频截取拼接合成一个新的mp3音频文件播放，下载。</div></div></a></div><div class="next-post pull_right"><a href="/2020/04/17/balls/"><img class="next_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Balls</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Xi Yu</div><div class="framework-info"><span>Driven </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>